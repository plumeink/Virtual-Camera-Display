<!DOCTYPE html>
<html lang="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="appTitle"></title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            font-family: Arial, sans-serif;
            user-select: none;
        }

        /* 拖动区域 - 全屏可拖动，除了控件区域 */
        .draggable {
            -webkit-app-region: drag;
        }

        /* 不可拖动区域 */
        .no-drag {
            -webkit-app-region: no-drag;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            background: #000;
        }

        #cameraPreview {
            width: 100%;
            height: 100%;
            object-fit: contain; /* 保持视频比例完整显示 */
            background: #000;
            margin: 0;
            padding: 0;
            position: absolute;
            top: 0;
            left: 0;
        }

        #videoContainer {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        #controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 10px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }

        #videoContainer:hover #controls {
            opacity: 1;
            pointer-events: auto;
        }

        .control-btn {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 0; /* 移除圆角 */
            cursor: pointer;
            font-size: 12px;
            -webkit-app-region: no-drag;
        }

        .control-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        #status {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 0; /* 移除圆角 */
            font-size: 12px;
            max-width: calc(100% - 20px);
            word-break: break-word;
            opacity: 0;
            transition: opacity 0.3s;
            -webkit-app-region: no-drag;
        }
        
        #resolutionDisplay {
            position: absolute;
            top: 40px;
            left: 10px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 5px 10px;
            border-radius: 0; /* 移除圆角 */
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.3s;
            -webkit-app-region: no-drag;
        }
        
        #videoContainer:hover #resolutionDisplay {
            opacity: 1;
        }
        
        #resolutionDisplay.hidden {
            display: none !important;
            opacity: 0 !important;
        }

        #videoContainer:hover #status {
            opacity: 1;
        }

        #deviceSelector {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #555;
            border-radius: 0; /* 移除圆角 */
            padding: 5px;
            min-width: 200px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            -webkit-app-region: no-drag;
        }

        #resolutionSelector {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: 1px solid #555;
            border-radius: 0; /* 移除圆角 */
            padding: 5px;
            min-width: 150px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
            -webkit-app-region: no-drag;
        }

        #resolutionSelector select,
        #resolutionSelector input {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid #777;
            border-radius: 3px;
            padding: 3px;
        }

        #resolutionSelector select option {
            background: #333;
            color: white;
        }

        #videoContainer:hover #resolutionSelector {
            opacity: 1;
            pointer-events: auto;
        }

        #videoContainer:hover #deviceSelector {
            opacity: 1;
            pointer-events: auto;
        }

        #permissionHelp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 20px;
            border-radius: 0; /* 移除圆角 */
            max-width: 80%;
            text-align: center;
            display: none;
            -webkit-app-region: no-drag;
        }

        #permissionHelp ul {
            text-align: left;
            margin: 15px 0;
        }

        #permissionHelp li {
            margin-bottom: 8px;
        }

        .help-btn {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 0; /* 移除圆角 */
            cursor: pointer;
            margin: 5px;
            -webkit-app-region: no-drag;
        }
    </style>
    <script type="module">
        // 导入i18n模块
        import i18n from './i18n.js';
        
        // 初始化i18n
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await i18n.init();
                
                // 初始化应用
                initApp(i18n);
                
                // 手动再次调用setupLanguageDropdown，确保语言选择下拉菜单显示
                setTimeout(() => {
                    console.log('Manually triggering setupLanguageDropdown...');
                    i18n.setupLanguageDropdown();
                }, 500);
            } catch (error) {
                console.error('初始化失败:', error);
                // 即使i18n初始化失败，也尝试启动应用
                const statusElement = document.getElementById('status');
                if (statusElement) {
                    statusElement.textContent = '初始化应用中...';
                }
                initApp({ t: (key) => key }); // 提供一个简单的t函数作为回退
            }
        });
        
        // 应用初始化函数
        function initApp(i18n) {
            const videoElement = document.getElementById('cameraPreview');
            const statusElement = document.getElementById('status');
            const refreshBtn = document.getElementById('refreshBtn');
            const closeBtn = document.getElementById('closeBtn');
            const deviceSelector = document.getElementById('deviceSelector');
            const permissionHelp = document.getElementById('permissionHelp');
            const helpBtn = document.getElementById('helpBtn');
            const retryBtn = document.getElementById('retryBtn');
            const closeHelpBtn = document.getElementById('closeHelpBtn');

            let currentStream = null;

            // 更新状态信息
            function updateStatus(message, isError = false) {
                statusElement.textContent = message;
                statusElement.style.color = isError ? '#ff6b6b' : 'white';
                console.log(isError ? i18n.t('errorPrefix') + message : i18n.t('statusPrefix') + message);

                // 如果是权限错误，显示帮助信息
                if (isError && (message.includes(i18n.t('cameraPermissionDenied')) || message.includes(i18n.t('noCameraFound')))) {
                    showPermissionHelp();
                }
            }

            // 显示权限帮助
            function showPermissionHelp() {
                permissionHelp.style.display = 'block';
            }

            // 隐藏权限帮助
            function hidePermissionHelp() {
                permissionHelp.style.display = 'none';
            }

            // 停止当前视频流
            function stopVideoStream() {
                if (currentStream) {
                    currentStream.getTracks().forEach(track => {
                        track.stop();
                        console.log('停止视频轨道:', track.label);
                    });
                    currentStream = null;
                }
            }

            // 获取可用摄像头设备
            async function getCameraDevices() {
                try {
                    // 先尝试枚举设备，这不需要完整的摄像头权限
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    console.log('枚举设备结果:', devices);
                    
                    const videoDevices = devices.filter(device => device.kind === 'videoinput');
                    console.log('找到的视频设备数量:', videoDevices.length);
                    videoDevices.forEach(device => console.log('设备信息:', device.label, 'ID:', device.deviceId));
                    
                    // 尝试请求一次权限，这有助于获取更详细的设备信息
                    try {
                        await navigator.mediaDevices.getUserMedia({ video: { width: 1, height: 1 } });
                        console.log('成功获取基本摄像头权限');
                    } catch (innerError) {
                        console.log('获取详细设备信息失败，但继续使用已有信息:', innerError.message);
                    }
                    
                    return videoDevices;
                } catch (error) {
                    console.error('获取设备列表失败:', error);
                    updateStatus(i18n.t('cameraGenericError') + error.message, true);
                    return [];
                }
            }

            // 填充设备选择器
            async function populateDeviceSelector() {
                const cameras = await getCameraDevices();
                deviceSelector.innerHTML = `<option value="">${i18n.t('deviceSelectorLabel')}</option>`;

                cameras.forEach(camera => {
                    const option = document.createElement('option');
                    option.value = camera.deviceId;
                    option.textContent = camera.label || i18n.t('unknownCamera') + deviceSelector.options.length;
                    deviceSelector.appendChild(option);
                });

                if (cameras.length > 0) {
                    deviceSelector.style.display = 'block';
                    return cameras;
                } else {
                    deviceSelector.style.display = 'none';
                    return [];
                }
            }

            // 启动指定摄像头的视频流
            async function startVideoStream(deviceId = null) {
                stopVideoStream();

                try {
                    updateStatus(i18n.t('accessingCamera'));

                    // 尝试获取OBS虚拟摄像头的原始分辨率
                    // 不设置固定尺寸限制，让摄像头使用其原生分辨率
                    const basicConstraints = {
                        video: {
                            width: { ideal: 1920 },  // 设置较高的理想值，让OBS可以返回其实际分辨率
                            height: { ideal: 1080 },
                            frameRate: { ideal: 30 },
                            facingMode: 'environment', // 对于虚拟摄像头，environment模式更合适
                            resizeMode: 'none' // 禁止浏览器自动调整尺寸
                        }
                    };

                    // 如果指定了设备ID，添加到约束中
                    if (deviceId) {
                        basicConstraints.video.deviceId = { exact: deviceId };
                    }

                    console.log('尝试获取媒体流，约束条件:', basicConstraints);
                    
                    // 使用try-catch来处理可能的权限错误
                    let stream;
                    try {
                        stream = await navigator.mediaDevices.getUserMedia(basicConstraints);
                        console.log('成功获取媒体流，轨道数量:', stream.getTracks().length);
                    } catch (initialError) {
                        console.error('首次尝试失败，使用更宽松的约束条件:', initialError);
                        // 使用更宽松的约束条件重试
                        const looseConstraints = {
                            video: deviceId ? { deviceId: { exact: deviceId } } : true
                        };
                        updateStatus(i18n.t('usingFallbackSettings'));
                        stream = await navigator.mediaDevices.getUserMedia(looseConstraints);
                        console.log('使用宽松约束条件成功获取媒体流');
                    }

                    videoElement.srcObject = stream;
                    currentStream = stream;

                    // 获取视频轨道信息
                    const videoTrack = stream.getVideoTracks()[0];
                    console.log('视频轨道信息:', videoTrack.label, '状态:', videoTrack.readyState);
                    
                    // 监听视频元数据加载完成事件，用于获取视频实际尺寸
                    videoElement.onloadedmetadata = function() {
                        updateVideoDimensions();
                    };
                    
                    // 初始设置视频尺寸变化事件监听，仅在自动检测模式下响应
                    videoElement.onresize = function() {
                        const presetResolution = document.getElementById('presetResolution');
                        if (presetResolution && presetResolution.value === 'auto') {
                            updateVideoDimensions();
                        }
                    };
                    
                    // 清理定时器的逻辑已移除，不再定期检测
                    
                    // 确保视频流稳定后再获取尺寸
                    let streamStabilized = false;
                    let stabilizationAttempts = 0;
                    const maxStabilizationAttempts = 5;
                    const stabilizationInterval = 500;
                    
                    // 更新视频尺寸并发送给主进程
                    function updateVideoDimensions() {
                        try {
                            if (window.electronAPI && typeof window.electronAPI.updateWindowSize === 'function' && 
                                videoElement && videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                                
                                const videoWidth = videoElement.videoWidth;
                                const videoHeight = videoElement.videoHeight;
                                console.log('检测到摄像头实际像素尺寸:', videoWidth, 'x', videoHeight);
                                
                                // 在界面上显示检测到的分辨率
                                const resolutionDisplay = document.getElementById('resolutionDisplay');
                                if (resolutionDisplay) {
                                    resolutionDisplay.textContent = i18n.t('resolutionDisplay') + videoWidth + '×' + videoHeight;
                                    resolutionDisplay.classList.remove('hidden');
                                }
                                
                                // 确保视频元素正确显示
                                videoElement.style.display = 'block';
                                videoElement.style.width = '100%';
                                videoElement.style.height = '100%';
                                
                                // 直接发送原始摄像头尺寸，不做任何缩放或调整
                                // 确保窗口严格按照摄像头输出的像素比例调整
                                window.electronAPI.updateWindowSize({ width: videoWidth, height: videoHeight });
                            } else if (videoElement) {
                                console.warn('无法获取有效的视频尺寸，使用默认尺寸');
                                // 确保视频元素至少可见
                                videoElement.style.display = 'block';
                                videoElement.style.width = '100%';
                                videoElement.style.height = '100%';
                            }
                        } catch (error) {
                            console.error('更新视频尺寸时发生错误:', error);
                            // 确保视频元素至少可见
                            if (videoElement) {
                                videoElement.style.display = 'block';
                                videoElement.style.width = '100%';
                                videoElement.style.height = '100%';
                            }
                        }
                    }
                    
                    // 视频流稳定性检查
                    function checkStreamStability() {
                        if (stabilizationAttempts >= maxStabilizationAttempts) {
                            streamStabilized = true;
                            console.log('视频流已稳定');
                            updateVideoDimensions(); // 最后再更新一次窗口尺寸
                            return;
                        }
                        
                        if (videoElement.videoWidth > 0 && videoElement.videoHeight > 0) {
                            console.log(`稳定性检查 #${stabilizationAttempts + 1}: 检测到尺寸 ${videoElement.videoWidth}x${videoElement.videoHeight}`);
                            stabilizationAttempts++;
                            setTimeout(checkStreamStability, stabilizationInterval);
                        } else {
                            console.log('视频尺寸尚未可用，等待...');
                            setTimeout(checkStreamStability, stabilizationInterval);
                        }
                    }
                    
                    // 启动稳定性检查
                    setTimeout(checkStreamStability, stabilizationInterval);
                    
                    updateStatus(i18n.t('cameraConnected') + videoTrack.label);
                    hidePermissionHelp();

                    // 监听视频流事件
                    videoTrack.onended = () => {
                        console.log('视频轨道已结束');
                        updateStatus(i18n.t('cameraDisconnected'), true);
                    };
                    
                    videoTrack.onerror = (event) => {
                        console.error('视频轨道错误:', event);
                        updateStatus(i18n.t('cameraError'), true);
                    };

                    return true;

                } catch (error) {
                    console.error('访问摄像头失败:', error);
                    
                    // 更详细的错误类型判断和处理
                    let errorMessage = i18n.t('cameraGenericError');
                    if (error.name === 'NotFoundError' || error.name === 'OverconstrainedError') {
                        errorMessage = i18n.t('noCameraFound');
                    } else if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                        errorMessage = i18n.t('cameraPermissionDenied');
                    } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
                        errorMessage = i18n.t('cameraInUse');
                    } else if (error.name === 'AbortError') {
                        errorMessage = i18n.t('cameraAborted');
                    } else {
                        errorMessage += error.message;
                    }
                    
                    updateStatus(errorMessage, true);
                    
                    // 显示更多帮助信息
                    showPermissionHelp();
                    
                    return false;
                }
            }

            // 自动尝试连接摄像头
            async function autoConnectCamera() {
                updateStatus(i18n.t('searchingCamera'));
                hidePermissionHelp();

                // 清理设备选择器
                deviceSelector.innerHTML = `<option value="">${i18n.t('deviceSelectorLabel')}</option>`;
                deviceSelector.style.display = 'none';

                try {
                    // 先尝试获取所有摄像头
                    const cameras = await getCameraDevices();
                    console.log('找到的摄像头数量:', cameras.length);

                    if (cameras.length === 0) {
                        updateStatus(i18n.t('noCameraFound'), true);
                        showPermissionHelp();
                        return;
                    }

                    // 填充设备选择器
                    cameras.forEach(camera => {
                        const option = document.createElement('option');
                        option.value = camera.deviceId;
                        option.textContent = camera.label || i18n.t('unknownCamera') + deviceSelector.options.length;
                        deviceSelector.appendChild(option);
                    });
                    
                    deviceSelector.style.display = 'block';
                    
                    // 定义更多OBS虚拟摄像头可能的标签关键词
                    const obsKeywords = ['obs', 'virtual', '虚拟', 'virtual camera', '虚拟摄像头', 'obs-camera'];
                    
                    // 尝试连接虚拟摄像头 (OBS Virtual Camera)
                    let obsCamera = null;
                    for (const camera of cameras) {
                        if (camera.label) {
                            const lowerLabel = camera.label.toLowerCase();
                            if (obsKeywords.some(keyword => lowerLabel.includes(keyword))) {
                                obsCamera = camera;
                                break;
                            }
                        }
                    }

                    if (obsCamera) {
                        updateStatus(i18n.t('obsCameraFound') + obsCamera.label);
                        console.log(i18n.t('connectingObsCamera'), obsCamera.label);
                        const success = await startVideoStream(obsCamera.deviceId);
                        if (!success) {
                            // 如果OBS虚拟摄像头连接失败，尝试所有可用摄像头
                            updateStatus(i18n.t('obsCameraFailed'));
                            for (const camera of cameras) {
                                if (camera.deviceId !== obsCamera.deviceId) {
                                    console.log(i18n.t('tryingOtherCamera'), camera.label);
                                    if (await startVideoStream(camera.deviceId)) {
                                        return;
                                    }
                                }
                            }
                            updateStatus(i18n.t('allCamerasFailed'), true);
                        }
                    } else {
                        // 如果没有找到OBS虚拟摄像头，尝试所有摄像头
                        updateStatus(i18n.t('noObsCameraFound'));
                        for (const camera of cameras) {
                            console.log(i18n.t('tryingCamera'), camera.label || i18n.t('unknownCamera'));
                            if (await startVideoStream(camera.deviceId)) {
                                return;
                            }
                        }
                        updateStatus(i18n.t('allCamerasFailed'), true);
                    }
                } catch (error) {
                    console.error('自动连接摄像头过程中发生错误:', error);
                    updateStatus(i18n.t('autoConnectFailed') + error.message, true);
                    showPermissionHelp();
                }
            }

            // 事件监听器
            refreshBtn.addEventListener('click', autoConnectCamera);

            closeBtn.addEventListener('click', () => {
                if (window.electronAPI && window.electronAPI.closeWindow) {
                    window.electronAPI.closeWindow();
                } else {
                    window.close();
                }
            });

            helpBtn.addEventListener('click', showPermissionHelp);

            retryBtn.addEventListener('click', autoConnectCamera);

            closeHelpBtn.addEventListener('click', hidePermissionHelp);

            deviceSelector.addEventListener('change', async (event) => {
                if (event.target.value) {
                    await startVideoStream(event.target.value);
                }
            });

            // 双击切换全屏
            videoElement.addEventListener('dblclick', () => {
                if (!document.fullscreenElement) {
                    videoElement.requestFullscreen().catch(err => {
                        console.error('全屏请求失败:', err);
                    });
                } else {
                    document.exitFullscreen();
                }
            });

            // 检查媒体设备支持
            if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                updateStatus(i18n.t('browserNotSupported'), true);
                return;
            }

            // 初始化分辨率选择器
            initializeResolutionSelector();
            
            // 等待一会儿再尝试连接，确保权限系统已就绪
            setTimeout(autoConnectCamera, 500);

            // 初始化分辨率选择器
            function initializeResolutionSelector() {
                const presetResolution = document.getElementById('presetResolution');
                const customWidth = document.getElementById('customWidth');
                const customHeight = document.getElementById('customHeight');
                const applyResolution = document.getElementById('applyResolution');
                
                // 设置placeholder
                customWidth.placeholder = i18n.t('widthPlaceholder');
                customHeight.placeholder = i18n.t('heightPlaceholder');
                
                // 预设分辨率选择事件
                presetResolution.addEventListener('change', function() {
                    if (this.value !== 'auto') {
                        const [width, height] = this.value.split('x').map(Number);
                        customWidth.value = width;
                        customHeight.value = height;
                    } else {
                        customWidth.value = '';
                        customHeight.value = '';
                    }
                });
                
                // 应用自定义分辨率
                applyResolution.addEventListener('click', function() {
                    if (customWidth.value && customHeight.value) {
                        const width = parseInt(customWidth.value);
                        const height = parseInt(customHeight.value);
                        
                        if (width > 0 && height > 0) {
                            updateStatus(i18n.t('applyCustomResolution') + width + 'x' + height);
                            applyCustomResolution(width, height);
                        } else {
                            updateStatus(i18n.t('invalidResolution'), true);
                        }
                    } else if (presetResolution.value !== 'auto') {
                        const [width, height] = presetResolution.value.split('x').map(Number);
                        updateStatus(i18n.t('applyPresetResolution') + width + 'x' + height);
                        applyCustomResolution(width, height);
                    } else {
                        updateStatus(i18n.t('autoResolutionMode'));
                        
                        // 隐藏分辨率显示标签
                        const resolutionDisplay = document.getElementById('resolutionDisplay');
                        if (resolutionDisplay) {
                            resolutionDisplay.classList.add('hidden');
                        }
                        
                        // 重置视频元素样式，让它能够自由调整大小以匹配摄像头原始分辨率
                        if (videoElement) {
                            videoElement.style.objectFit = 'none';
                            videoElement.style.width = '100%';
                            videoElement.style.height = '100%';
                        }
                        
                        // 强制重新获取摄像头原始分辨率
                        if (currentStream && videoElement) {
                            // 停止当前流
                            stopVideoStream();
                            // 重新连接摄像头以获取原始分辨率
                            setTimeout(() => {
                                autoConnectCamera();
                            }, 100);
                        }
                        
                        // 重新启用视频尺寸变化监听
                        videoElement.onresize = function() {
                            updateVideoDimensions();
                        };
                        
                        // 重新启用视频元数据加载完成事件监听
                        videoElement.onloadedmetadata = function() {
                            updateVideoDimensions();
                        };
                    }
                });
            }
            
            // 应用自定义分辨率并调整窗口大小
            function applyCustomResolution(width, height) {
                console.log('应用自定义分辨率:', width, 'x', height);
                
                // 确认window.electronAPI是否存在
                if (!window.electronAPI) {
                    console.error('electronAPI对象不存在');
                    return;
                }
                
                if (!window.electronAPI.updateWindowSize) {
                    console.error('updateWindowSize方法不存在');
                    return;
                }
                
                // 尝试修改视频元素的样式以匹配指定分辨率
                if (videoElement) {
                    videoElement.style.objectFit = 'contain';
                }
                
                // 禁用视频尺寸变化的自动检测，防止窗口大小被重置
                videoElement.onresize = function() {
                    // 在手动设置分辨率模式下不响应视频尺寸变化
                };
                
                // 使用setTimeout延迟调用，确保没有其他代码干扰
                setTimeout(() => {
                    // 强制调整窗口大小到指定分辨率
                    console.log('调整窗口尺寸:', width, 'x', height);
                    window.electronAPI.updateWindowSize({ width: width, height: height });
                    console.log('窗口尺寸更新请求已发送');
                }, 100);
                
                // 在分辨率显示区域显示当前使用的自定义分辨率
                const resolutionDisplay = document.getElementById('resolutionDisplay');
                if (resolutionDisplay) {
                    resolutionDisplay.textContent = i18n.t('customResolutionDisplay') + width + '×' + height;
                    resolutionDisplay.classList.remove('hidden');
                }
            }
            
            // 强制设置窗口尺寸（不依赖摄像头自动检测）
            function forceWindowSize(width, height) {
                if (window.electronAPI && typeof window.electronAPI.updateWindowSize === 'function') {
                    // 直接发送指定尺寸，与自动检测模式保持一致的窗口大小更新行为
                    console.log('强制设置窗口尺寸:', width, 'x', height);
                    window.electronAPI.updateWindowSize({ width: width, height: height });
                }
            }

            // 处理页面可见性变化 - 修改为保活模式
            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    // 页面隐藏时保持视频播放（不再暂停）
                    console.log('页面隐藏，保持视频播放');
                    // 确保视频继续播放，添加额外的保活逻辑
                    keepVideoAlive();
                } else {
                    // 页面显示时确保视频正常播放
                    videoElement.play().catch(e => {
                        console.error('恢复播放失败:', e);
                        // 尝试重新初始化视频流
                        setTimeout(() => {
                            if (currentStream) {
                                console.log('尝试重新播放视频');
                                videoElement.play().catch(innerError => {
                                    console.error('再次尝试播放失败:', innerError);
                                    // 如果仍然失败，考虑重新连接摄像头
                                    autoConnectCamera();
                                });
                            }
                        }, 500);
                    });
                }
            });

            // 保活功能 - 确保视频在后台继续播放
            let keepAliveInterval = null;
            
            function keepVideoAlive() {
                // 清除之前的定时器（如果存在）
                if (keepAliveInterval) {
                    clearInterval(keepAliveInterval);
                }
                
                // 设置新的定时器，定期检查并保持视频流活跃
                keepAliveInterval = setInterval(() => {
                    if (document.hidden && currentStream && videoElement) {
                        try {
                            // 检查视频是否仍然在播放
                            if (videoElement.paused) {
                                console.log('视频在后台被暂停，尝试恢复播放');
                                videoElement.play().catch(e => {
                                    console.error('后台恢复播放失败:', e);
                                    // 如果播放失败，尝试重新初始化视频流
                                    if (currentStream) {
                                        const videoTrack = currentStream.getVideoTracks()[0];
                                        if (videoTrack && videoTrack.readyState === 'ended') {
                                            console.log('视频轨道已结束，尝试重新连接摄像头');
                                            autoConnectCamera();
                                        }
                                    }
                                });
                            }
                        } catch (error) {
                            console.error('保活检查时发生错误:', error);
                        }
                    }
                }, 2000); // 每2秒检查一次
            }

            // 当窗口重新获得焦点时清理保活定时器
            window.addEventListener('focus', () => {
                if (keepAliveInterval) {
                    clearInterval(keepAliveInterval);
                    keepAliveInterval = null;
                    console.log('窗口获得焦点，停止保活检查');
                }
            });

            // 定期检查摄像头连接状态
            setInterval(() => {
                if (currentStream) {
                    const videoTrack = currentStream.getVideoTracks()[0];
                    if (videoTrack && videoTrack.readyState === 'ended') {
                        updateStatus(i18n.t('cameraDisconnected'), true);
                        stopVideoStream();
                    }
                }
            }, 5000);
        }
    </script>
</head>
<body>
<!-- 拖动区域：全屏拖动，但控件区域不可拖动 -->
<div id="videoContainer" class="draggable">
    <video id="cameraPreview" autoplay playsinline></video>

    <div id="status" data-i18n="initStatus"></div>
    <div id="resolutionDisplay" data-i18n="resolutionDisplay"><span data-i18n="noResolutionDetected"></span></div>

    <div id="controls" class="no-drag">
        <button class="control-btn" id="refreshBtn" data-i18n="refreshBtn"></button>
        <button class="control-btn" id="helpBtn" data-i18n="helpBtn"></button>
        <button class="control-btn" id="closeBtn" data-i18n="closeBtn"></button>
    </div>

    <select id="deviceSelector" class="no-drag" style="display: none;">
        <option value="" data-i18n="deviceSelectorLabel"></option>
    </select>

    <!-- 分辨率选择器 -->
    <div id="resolutionSelector">
        <label for="presetResolution" data-i18n="presetResolutionLabel"></label>
        <select id="presetResolution">
            <option value="auto" data-i18n="autoDetectResolution"></option>
            <option value="1920x1080">1920x1080</option>
            <option value="1280x720">1280x720</option>
            <option value="1024x768">1024x768</option>
            <option value="800x600">800x600</option>
            <option value="640x480">640x480</option>
        </select>
        <span data-i18n="customResolutionLabel"></span>
        <input type="number" id="customWidth" min="1" max="4096" size="4">
        <span>x</span>
        <input type="number" id="customHeight" min="1" max="4096" size="4">
        <button id="applyResolution" class="control-btn" data-i18n="applyResolutionBtn"></button>
    </div>

    <div id="permissionHelp">
        <h3 data-i18n="permissionHelpTitle"></h3>
        <p data-i18n="permissionHelpMessage"></p>
        <ul>
            <li data-i18n="permissionHelpStep1"></li>
            <li data-i18n="permissionHelpStep2"></li>
            <li data-i18n="permissionHelpStep3"></li>
            <li data-i18n="permissionHelpStep4"></li>
        </ul>
        <button class="help-btn" id="retryBtn" data-i18n="retryBtn"></button>
        <button class="help-btn" id="closeHelpBtn" data-i18n="closeHelpBtn"></button>
    </div>
</div>
</div>

</body>
</html>